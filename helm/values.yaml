# CloudJet Helm Chart Values
# This is a YAML-formatted file for the CloudJet microservices application

# Global settings
global:
  namespace: user  # Default namespace
  applicationNamespaces: ["user", "admin"]
  imagePullPolicy: Always

# Individual microservice configurations
services:
  auth:
    enabled: true
    name: auth-service
    image:
      repository: public.ecr.aws/v3g6g4v7/cj-auth-svc
      tag: v1.0.9
    port: 5001
    replicas: 2
    rollout:
      enabled: true
      autoPromotion: true
      analysis:
        enabled: true
        performance: false
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  flight:
    enabled: true
    name: flight-service
    image:
      repository: public.ecr.aws/v3g6g4v7/cj-flight-svc
      tag: v1.0.0
    port: 5002
    replicas: 2
    rollout:
      enabled: true
      autoPromotion: true
      analysis:
        enabled: true
        performance: false
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  booking:
    enabled: true
    name: booking-service
    image:
      repository: public.ecr.aws/v3g6g4v7/cj-booking-svc
      tag: v2.0.3
    port: 5003
    replicas: 2
    rollout:
      enabled: true
      autoPromotion: true
      analysis:
        enabled: true
        performance: false
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  payment:
    enabled: true
    name: payment-service
    image:
      repository: public.ecr.aws/v3g6g4v7/cj-payment-svc
      tag: v2.0.3
    port: 5005
    replicas: 1
    rollout:
      enabled: true
      autoPromotion: true
      analysis:
        enabled: true
        performance: false
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

  admin:
    enabled: true
    name: admin-service
    image:
      repository: public.ecr.aws/v3g6g4v7/cj-admin-svc
      tag: v2.0.3
    port: 5004
    namespace: admin  # Admin service goes to admin namespace
    replicas: 1
    rollout:
      enabled: true
      autoPromotion: true
      analysis:
        enabled: true
        performance: false
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"

# Configuration settings
config:
  # Flask environment
  flaskEnv: production
  pythonPath: /app
  
  # Database settings (non-sensitive)
  database:
    host: db.cloudjet.internal
    name: cloudjet_simple
    user: admin
    port: 3306
    poolSize: 5
  
  # Redis/ElastiCache settings
  redis:
    host: redis.cloudjet.internal
    port: 6379
    db: 0
    ssl: true
  
  # Service URLs for inter-service communication
  serviceUrls:
    auth: http://auth-service-active:5001
    flight: http://flight-service-active:5002
    booking: http://booking-service-active:5003
    payment: http://payment-service-active:5005
    admin: http://admin-service.admin.svc.cluster.local:80
  
  # Cache settings
  cache:
    ttl: 300
    searchTtl: 600

# Secret settings (will be handled by External Secrets)
secrets:
  enabled: true
  externalSecrets:
    enabled: true
    storeName: aws-secrets-store
    serviceAccountName: cloudjet-secrets-sa
 
# ServiceAccounts 설정
serviceAccounts:
  enabled: true
  accounts:
    - name: cloudjet-secrets-sa
      enabled: true
      roleArn: arn:aws:iam::556683426101:role/CloudJetSecretsRole
      namespaces: ["user", "admin"]


# Istio settings
istio:
  enabled: true
  gateway:
    enabled: true
    name: cloudjet-gateway
    hosts:
      - "api.cloudjet.click"
      - "cloudjet.click"
      - "www.cloudjet.click"
      - "kiali.cloudjet.click"
      - "jaeger.cloudjet.click"
      - "grafana.cloudjet.click"
  virtualService:
    enabled: true
    name: cloudjet-vs
    apiHost: "api.cloudjet.click"
    frontendHost: "cloudjet.click"
  destinationRule:
    enabled: true
    name: auth-service-dr
  sidecarInjection:
    enabled: true

# KEDA Configuration
keda:
  enabled: false
  scaledObjects:
    - name: booking-service
      enabled: false
      targetDeployment: booking-service
      namespace: user
      minReplicas: 1
      maxReplicas: 10
      pollingInterval: 30
      cooldownPeriod: 300
      prometheus:
        # Option 1: Istio 요청 수 기반 스케일링 (Service Mesh 환경)
        metricName: istio_request_rate
        query: rate(istio_requests_total{destination_service_name="booking-service"}[1m])
        threshold: 10
        
        # Option 2: 일반 HTTP 요청 수 기반 스케일링 (PromQL 직접 사용)
        # 애플리케이션이 /metrics 엔드포인트로 메트릭을 노출하는 경우
        # metricName: http_requests_per_second
        # query: rate(http_requests_total{job="booking-service"}[1m])
        # threshold: 5

# Namespace creation
namespaces:
  - name: user
    istioInjection: enabled
  - name: admin
    istioInjection: enabled
  - name: monitoring